---

- name: purge unnecessary packages
  apt: name={{ item }} state=absent purge=yes
  with_items: '{{ di_system_removed_packages }}'
  when: di_system_removed_packages | length > 0

- name: install necessary packages
  apt: name={{ item }} state=present update_cache=yes
  with_items: '{{ di_system_installed_packages }}'
  when: di_system_installed_packages | length > 0

- name: install fail2ban package
  apt: name=fail2ban state=present
  when: di_system_fail2ban_enabled

- name: enable fail2ban service
  service: name=fail2ban state=started enabled=yes
  when: di_system_fail2ban_enabled

- name: install vnstat package
  apt: name=vnstat state=present
  when: di_system_vnstat_enabled

- name: enable vnstat service
  service: name=vnstat state=started enabled=yes
  when: di_system_vnstat_enabled

- name: set timezone
  timezone: name={{ di_system_timezone }}
  notify: restart cron

- name: enable time sync
  command: timedatectl set-ntp true
  when: di_system_timesync_enabled

- name: install unattended upgrades packages
  apt: name={{ item }} state=present
  with_items:
    - unattended-upgrades
    - apt-listchanges
  when: di_system_unattended_upgrades_enabled

- name: enable unattended upgrades
  copy:
    src: 20auto-upgrades
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    mode: 0644
  when: di_system_unattended_upgrades_enabled

- name: fix unattended upgrades cron not running (test)
  stat: path=/etc/cron.daily/apt.disabled
  register: apt_disabled
  when: di_system_unattended_upgrades_enabled

- name: fix unattended upgrades cron not running (fix)
  command: mv /etc/cron.daily/apt.disabled /etc/cron.daily/apt
  when: di_system_unattended_upgrades_enabled and apt_disabled.stat.exists
